<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Route Tracking</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 50%, #1a472a 100%);
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.03)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.03)"/><circle cx="50" cy="10" r="1" fill="rgba(255,255,255,0.02)"/><circle cx="90" cy="40" r="1" fill="rgba(255,255,255,0.02)"/></pattern></defs><rect width="100%" height="100%" fill="url(%23grain)"/></svg>');
            opacity: 0.4;
            z-index: 1;
        }

        .navbar {
            background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 50%, #1a472a 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 10;
            border-bottom: 3px solid #d4af37;
        }

        .navbar h1 {
            font-size: 28px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            color: #fff;
        }

        .navbar-links {
            display: flex;
            gap: 25px;
            align-items: center;
        }

        .navbar-links a {
            color: #fff;
            text-decoration: none;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid transparent;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            cursor: pointer;
        }

        .navbar-links a:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: #d4af37;
            transform: translateY(-2px);
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
            position: relative;
            z-index: 5;
        }

        .page-header {
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #d4af37;
        }

        .page-header h2 {
            color: #fff;
            font-size: 32px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            text-align: center;
        }

        .controls-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border: 2px solid #d4af37;
            padding: 25px;
            margin-bottom: 25px;
        }

        .controls-section h3 {
            color: #1a472a;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .controls-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 15px;
        }

        .control-group {
            flex: 1;
            min-width: 180px;
            max-width: 200px;
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1a472a;
            font-size: 13px;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #d4af37;
            border-radius: 8px;
            font-size: 13px;
            transition: border-color 0.3s ease;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #b8941f;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
        }

        .datetime-group {
            display: flex;
            gap: 20px;
            align-items: center;
            min-width: 340px;
        }

        .datetime-item {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 150px;
        }

        .datetime-item label {
            font-weight: 600;
            color: #1a472a;
            font-size: 13px;
            white-space: nowrap;
        }

        .datetime-item input {
            flex: 1;
            padding: 10px;
            border: 2px solid #d4af37;
            border-radius: 8px;
            font-size: 13px;
        }

        .datetime-item.end-datetime {
            margin-left: 20px;
        }

        .button-group {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 10px;
        }

        .btn {
            display: inline-block;
            background: linear-gradient(145deg, #d4af37, #b8941f);
            color: #1a472a;
            padding: 10px 18px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 13px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            min-width: 75px;
            text-align: center;
        }

        .btn:hover:not(:disabled) {
            background: linear-gradient(145deg, #b8941f, #d4af37);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(145deg, #28a745, #218838);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: linear-gradient(145deg, #218838, #28a745);
        }

        .btn-danger {
            background: linear-gradient(145deg, #dc3545, #c82333);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: linear-gradient(145deg, #c82333, #dc3545);
        }

        .btn-warning {
            background: linear-gradient(145deg, #ffc107, #e0a800);
            color: #1a472a;
        }

        .btn-warning:hover:not(:disabled) {
            background: linear-gradient(145deg, #e0a800, #ffc107);
        }

        .btn-secondary {
            background: linear-gradient(145deg, #6c757d, #545b62);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: linear-gradient(145deg, #545b62, #6c757d);
        }

        .btn-orange {
            background: linear-gradient(145deg, #e67e22, #d35400);
            color: white;
        }

        .btn-orange:hover:not(:disabled) {
            background: linear-gradient(145deg, #d35400, #e67e22);
        }

        .btn-purple {
            background: linear-gradient(145deg, #9b59b6, #8e44ad);
            color: white;
        }

        .btn-purple:hover:not(:disabled) {
            background: linear-gradient(145deg, #8e44ad, #9b59b6);
        }

        .info-panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border: 2px solid #d4af37;
            padding: 20px;
            display: none;
        }

        .info-panel.active {
            display: block;
        }

        .info-panel h4 {
            color: #1a472a;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            border-bottom: 1px solid #d4af37;
            padding-bottom: 8px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #d4af37;
        }

        .info-item strong {
            color: #1a472a;
            display: block;
            font-size: 0.9em;
            margin-bottom: 4px;
        }

        .info-item span {
            color: #495057;
            font-size: 1em;
        }

        .stats-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border: 2px solid #d4af37;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .stats-panel.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #d4af37;
        }

        .stat-card h5 {
            color: #1a472a;
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #495057;
            font-weight: 600;
            font-size: 0.9em;
        }

        .map-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border: 2px solid #d4af37;
            overflow: hidden;
            height: 600px;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 25px 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
            display: none;
            border: 2px solid #d4af37;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #d4af37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 2px solid #dc3545;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: center;
            display: none;
            font-weight: 500;
        }

        .error-message.active {
            display: block;
        }

        .legend {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 13px;
            border: 2px solid #d4af37;
            min-width: 180px;
        }

        .legend h5 {
            color: #1a472a;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: bold;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .legend-line {
            width: 20px;
            height: 3px;
            margin-right: 8px;
            border-radius: 2px;
        }

        .logout-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .logout-modal-content {
            background-color: #fff;
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border: 2px solid #d4af37;
            text-align: center;
        }

        .logout-modal h3 {
            color: #1a472a;
            font-size: 20px;
            margin-bottom: 20px;
        }

        .logout-modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .logout-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn-cancel {
            background: #6c757d;
            color: white;
        }

        .logout-btn-cancel:hover {
            background: #545b62;
        }

        .logout-btn-confirm {
            background: linear-gradient(145deg, #d4af37, #b8941f);
            color: #1a472a;
        }

        .logout-btn-confirm:hover {
            background: linear-gradient(145deg, #b8941f, #d4af37);
        }

        /* Responsive design */
        @media (max-width: 1024px) {
            .controls-row {
                justify-content: flex-start;
            }

            .control-group {
                min-width: 160px;
                max-width: 180px;
            }

            .datetime-group {
                min-width: 280px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }

            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group,
            .datetime-group {
                min-width: 100%;
                max-width: 100%;
            }

            .datetime-group {
                flex-direction: column;
            }

            .info-panels {
                grid-template-columns: 1fr;
            }

            .navbar {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }

            .navbar h1 {
                font-size: 24px;
            }

            .page-header h2 {
                font-size: 24px;
            }

            .map-container {
                height: 500px;
            }

            .legend {
                position: relative;
                bottom: auto;
                right: auto;
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <h1>Vehicle Route Tracking</h1>
        <div class="navbar-links">
            <a href="/dashboard">Dashboard</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <div class="page-header">
            <h2>Vehicle Route Tracking Dashboard</h2>
        </div>

        <!-- Vehicle Selection and Controls -->
        <div class="controls-section">
            <h3>Vehicle Selection & Time Period</h3>
            <div class="controls-row">
                <div class="control-group">
                    <label for="vehicleSelect">Vehicle (BA Number)</label>
                    <select id="vehicleSelect">
                        <option value="">-- Select Vehicle --</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="baNumberInput">Or Enter BA Number</label>
                    <input type="text" id="baNumberInput" placeholder="Enter BA Number" />
                </div>
                <div class="datetime-group">
                    <div class="datetime-item">
                        <label for="startDateTime">Start Date & Time</label>
                        <input type="datetime-local" id="startDateTime" />
                    </div>
                    <div class="datetime-item end-datetime">
                        <label for="endDateTime">End Date & Time</label>
                        <input type="datetime-local" id="endDateTime" />
                    </div>
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-success" id="loadRouteBtn" onclick="loadRoute()">Load Route</button>
                <button class="btn btn-danger" id="harshBrakeBtn" onclick="toggleEvent('harsh_brake')" disabled>Harsh Braking</button>
                <button class="btn btn-orange" id="harshAccelBtn" onclick="toggleEvent('harsh_acceleration')" disabled>Harsh Acceleration</button>
                <button class="btn btn-warning" id="overspeedBtn" onclick="toggleEvent('overspeeding')" disabled>Overspeeding</button>
                <button class="btn btn-secondary" onclick="clearMap()">Clear</button>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error-message"></div>

        <!-- Information Panels -->
        <div class="info-panels">
            <!-- Vehicle Information Panel -->
            <div id="vehicleInfoPanel" class="info-panel">
                <h4>Vehicle Information</h4>
                <div id="vehicleInfo" class="info-grid">
                    <!-- Vehicle details will be populated here -->
                </div>
            </div>

            <!-- Driver Information Panel -->
            <div id="driverInfoPanel" class="info-panel">
                <h4>Driver(s) Information</h4>
                <div id="driverInfo" class="info-grid">
                    <!-- Driver details will be populated here -->
                </div>
            </div>
        </div>

        <!-- Statistics Panel -->
        <div id="statsPanel" class="stats-panel">
            <h4 style="color: #1a472a; font-size: 18px; font-weight: bold; margin-bottom: 15px; text-align: center;">Route Statistics</h4>
            <div class="stats-grid">
                <div class="stat-card">
                    <h5 id="totalDistance">0</h5>
                    <p>Total Distance (km)</p>
                </div>
                <div class="stat-card">
                    <h5 id="maxSpeed">0</h5>
                    <p>Max Speed (km/h)</p>
                </div>
                <div class="stat-card">
                    <h5 id="avgSpeed">0</h5>
                    <p>Avg Speed (km/h)</p>
                </div>
                <div class="stat-card">
                    <h5 id="duration">0</h5>
                    <p>Duration (hours)</p>
                </div>
                <div class="stat-card">
                    <h5 id="totalPoints">0</h5>
                    <p>GPS Points</p>
                </div>
                <div class="stat-card">
                    <h5 id="driverCount">0</h5>
                    <p>Total Drivers</p>
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>
            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                <div id="loadingText">Loading route data...</div>
            </div>
            <div class="legend">
                <h5>Map Legend</h5>
                <div class="legend-item">
                    <div class="legend-line" style="background: #3498db;"></div>
                    <span>Route Path</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #2ecc71;"></div>
                    <span>Start Point</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #95a5a6;"></div>
                    <span>End Point</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #dc3545;"></div>
                    <span>Overspeeding</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e67e22;"></div>
                    <span>Harsh Braking</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #9b59b6;"></div>
                    <span>Harsh Acceleration</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Logout Modal -->
    <div id="logoutModal" class="logout-modal">
        <div class="logout-modal-content">
            <h3>Logout Confirmation</h3>
            <p>Are you sure you want to logout?</p>
            <div class="logout-modal-buttons">
                <button class="logout-btn logout-btn-cancel" onclick="closeLogoutModal()">Cancel</button>
                <button class="logout-btn logout-btn-confirm" onclick="confirmLogout()">OK</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Global variables
        let routeLoaded = false;
        let map;
        let currentPath = null;
        let currentMarkers = [];
        let eventMarkers = {
            harsh_brake: [],
            harsh_acceleration: [],
            overspeeding: []
        };
        let activeEvents = new Set();
        let currentVehicleId = null;
        let currentRouteData = null;

        // DOM elements
        const vehicleSelect = document.getElementById('vehicleSelect');
        const baNumberInput = document.getElementById('baNumberInput');
        const startDateTime = document.getElementById('startDateTime');
        const endDateTime = document.getElementById('endDateTime');
        const loadRouteBtn = document.getElementById('loadRouteBtn');
        const harshBrakeBtn = document.getElementById('harshBrakeBtn');
        const harshAccelBtn = document.getElementById('harshAccelBtn');
        const overspeedBtn = document.getElementById('overspeedBtn');
        const errorMessage = document.getElementById('errorMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const loadingText = document.getElementById('loadingText');
        const vehicleInfoPanel = document.getElementById('vehicleInfoPanel');
        const driverInfoPanel = document.getElementById('driverInfoPanel');
        const statsPanel = document.getElementById('statsPanel');
        const vehicleInfo = document.getElementById('vehicleInfo');
        const driverInfo = document.getElementById('driverInfo');

        // Initialize map
        function initMap() {
            map = L.map('map').setView([33.6844, 73.0479], 12); // Default to Islamabad

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadVehicles();
            setDefaultDateTime();

            // Add event listeners
            vehicleSelect.addEventListener('change', onVehicleSelect);
            baNumberInput.addEventListener('input', onBANumberInput);
        });

        // Set default date time (last 24 hours)
        function setDefaultDateTime() {
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);

            endDateTime.value = formatDateTimeLocal(now);
            startDateTime.value = formatDateTimeLocal(yesterday);
        }

        // Format date for datetime-local input
        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');

            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // Load vehicles list
        async function loadVehicles() {
            try {
                showLoading(true, 'Loading vehicles...');
                const response = await fetch('/api/vehicles-for-route');
                const data = await response.json();

                if (data.success) {
                    vehicleSelect.innerHTML = '<option value="">-- Select Vehicle --</option>';
                    data.vehicles.forEach(vehicle => {
                        const option = document.createElement('option');
                        option.value = vehicle.id;
                        option.textContent = vehicle.BA_number;
                        vehicleSelect.appendChild(option);
                    });
                } else {
                    showError('Failed to load vehicles: ' + data.message);
                }
            } catch (error) {
                showError('Failed to load vehicles: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Handle vehicle selection from dropdown
        function onVehicleSelect() {
            const selectedValue = vehicleSelect.value;
            if (selectedValue) {
                baNumberInput.value = '';
                currentVehicleId = selectedValue;
            } else {
                currentVehicleId = null;
            }
            hideError();
        }

        // Handle BA number input
        function onBANumberInput() {
            const inputValue = baNumberInput.value.trim();
            if (inputValue) {
                vehicleSelect.value = '';
                currentVehicleId = inputValue;
            } else {
                currentVehicleId = null;
            }
            hideError();
        }

        // Resolve BA Number to vehicle ID
        async function resolveBANumber(baNumber) {
            try {
                const response = await fetch(`/api/vehicle-by-ba-for-route/${baNumber}`);
                const data = await response.json();

                if (data.success) {
                    return data.vehicle.id;
                }
                return null;
            } catch (error) {
                console.error('Error resolving BA number:', error);
                return null;
            }
        }

        // Load route
        async function loadRoute() {
            if (!currentVehicleId) {
                showError('Please select a vehicle or enter a BA number');
                return;
            }

            if (!startDateTime.value || !endDateTime.value) {
                showError('Please select start and end date/time');
                return;
            }

            if (new Date(startDateTime.value) >= new Date(endDateTime.value)) {
                showError('Start date/time must be before end date/time');
                return;
            }

            try {
                showLoading(true, 'Loading route data...');

                // Resolve BA number if needed
                let vehicleId = currentVehicleId;
                if (baNumberInput.value.trim()) {
                    const resolvedId = await resolveBANumber(baNumberInput.value.trim());
                    if (!resolvedId) {
                        showError('Vehicle with BA number "' + baNumberInput.value.trim() + '" not found');
                        return;
                    }
                    vehicleId = resolvedId;
                }

                // Load route data
                const routeResponse = await fetch(`/api/route-data?vehicle_id=${vehicleId}&start=${startDateTime.value}&end=${endDateTime.value}`);
                const routeData = await routeResponse.json();

                if (!routeData.success) {
                    throw new Error(routeData.message || 'Failed to load route data');
                }

                if (routeData.gps_points.length === 0) {
                    showError('No GPS data found for the selected time period');
                    return;
                }

                currentRouteData = routeData;
                currentVehicleId = vehicleId;

                // Display route on map
                displayRoute(routeData.gps_points);

                // Update statistics
                updateStatistics(routeData);

                // Display vehicle information
                displayVehicleInformation(routeData.vehicle_info);

                // Display driver information
                displayDriverInformation(routeData.driver_info);

                routeLoaded = true;
                currentRouteData = routeData;
                currentVehicleId = vehicleId;

                // Enable event buttons
                harshBrakeBtn.disabled = false;
                harshAccelBtn.disabled = false;
                overspeedBtn.disabled = false;

                hideError();

            } catch (error) {
                showError('Failed to load route: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Display route on map
        function displayRoute(gpsPoints) {
            // Clear existing route
            clearMap();

            if (gpsPoints.length === 0) return;

            // Create route path
            const routeCoords = gpsPoints.map(point => [point.lat, point.lon]);

            currentPath = L.polyline(routeCoords, {
                color: '#3498db',
                weight: 4,
                opacity: 0.8
            }).addTo(map);

            // Add start marker
            const startPoint = gpsPoints[0];
            const startMarker = L.marker([startPoint.lat, startPoint.lon], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background: #2ecc71; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(map);

            startMarker.bindPopup(`
                <b>Start Point</b><br>
                Time: ${new Date(startPoint.timestamp).toLocaleString()}<br>
                Speed: ${startPoint.speed || 0} km/h<br>
                Driver: ${startPoint.driver_id || 'Unknown'}
            `);

            // Add end marker
            const endPoint = gpsPoints[gpsPoints.length - 1];
            const endMarker = L.marker([endPoint.lat, endPoint.lon], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background: #95a5a6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(map);

            endMarker.bindPopup(`
                <b>End Point</b><br>
                Time: ${new Date(endPoint.timestamp).toLocaleString()}<br>
                Speed: ${endPoint.speed || 0} km/h<br>
                Driver: ${endPoint.driver_id || 'Unknown'}
            `);

            currentMarkers.push(startMarker, endMarker);

            // Fit map to route
            map.fitBounds(currentPath.getBounds(), { padding: [20, 20] });
        }

        // Toggle event display
        async function toggleEvent(eventType) {
            if (!routeLoaded || !currentVehicleId) {
                showError('Please load a route first');
                return;
            }

            try {
                if (activeEvents.has(eventType)) {
                    // Remove event markers
                    eventMarkers[eventType].forEach(marker => map.removeLayer(marker));
                    eventMarkers[eventType] = [];
                    activeEvents.delete(eventType);
                    updateButtonState(eventType, false);
                } else {
                    // Load and display event markers
                    showLoading(true, `Loading ${eventType} events...`);

                    const response = await fetch(`/api/events?vehicle_id=${currentVehicleId}&event_type=${eventType}&start=${startDateTime.value}&end=${endDateTime.value}`);
                    const data = await response.json();

                    if (data.success) {
                        displayEventMarkers(eventType, data.events);
                        activeEvents.add(eventType);
                        updateButtonState(eventType, true);
                    } else {
                        showError('Failed to load ' + eventType + ' events: ' + data.message);
                    }
                }
            } catch (error) {
                showError('Failed to toggle ' + eventType + ': ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Display event markers
        function displayEventMarkers(eventType, events) {
            const eventConfig = {
                harsh_brake: { color: '#e67e22', name: 'Harsh Braking' },
                harsh_acceleration: { color: '#9b59b6', name: 'Harsh Acceleration' },
                overspeeding: { color: '#dc3545', name: 'Overspeeding' }
            };

            const config = eventConfig[eventType];

            events.forEach((event, index) => {
                const marker = L.marker([event.lat, event.lon], {
                    icon: L.divIcon({
                        className: 'event-marker',
                        html: `<div style="background: ${config.color}; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`,
                        iconSize: [15, 15],
                        iconAnchor: [7.5, 7.5]
                    })
                }).addTo(map);

                marker.bindPopup(`
                    <b>${config.name} Event #${index + 1}</b><br>
                    Time: ${new Date(event.timestamp).toLocaleString()}<br>
                    Driver: ${event.driver_id || 'Unknown'}<br>
                    Location: ${event.lat.toFixed(6)}, ${event.lon.toFixed(6)}
                `);

                eventMarkers[eventType].push(marker);
            });
        }

        // Update button state
        function updateButtonState(eventType, active) {
            const buttons = {
                harsh_brake: harshBrakeBtn,
                harsh_acceleration: harshAccelBtn,
                overspeeding: overspeedBtn
            };

            const button = buttons[eventType];
            if (active) {
                button.style.opacity = '0.7';
                button.style.transform = 'scale(0.95)';
            } else {
                button.style.opacity = '1';
                button.style.transform = 'scale(1)';
            }
        }

        // Update statistics
        function updateStatistics(data) {
            if (!data || !data.gps_points.length) return;

            const gpsPoints = data.gps_points;
            const totalPoints = gpsPoints.length;

            // Calculate total distance
            let totalDistance = 0;
            for (let i = 1; i < gpsPoints.length; i++) {
                const prevPoint = gpsPoints[i - 1];
                const currPoint = gpsPoints[i];
                const distance = calculateDistance(prevPoint.lat, prevPoint.lon, currPoint.lat, currPoint.lon);
                totalDistance += distance;
            }

            // Calculate speeds
            const speeds = gpsPoints.map(point => point.speed || 0);
            const maxSpeed = Math.max(...speeds);
            const avgSpeed = speeds.reduce((sum, speed) => sum + speed, 0) / speeds.length;

            // Calculate duration
            const startTime = new Date(gpsPoints[0].timestamp);
            const endTime = new Date(gpsPoints[gpsPoints.length - 1].timestamp);
            const duration = (endTime - startTime) / (1000 * 60 * 60); // hours

            // Get unique drivers
            const uniqueDrivers = [...new Set(gpsPoints.map(point => point.driver_id).filter(id => id))];

            // Update display
            document.getElementById('totalDistance').textContent = totalDistance.toFixed(2);
            document.getElementById('maxSpeed').textContent = maxSpeed.toFixed(1);
            document.getElementById('avgSpeed').textContent = avgSpeed.toFixed(1);
            document.getElementById('duration').textContent = duration.toFixed(1);
            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('driverCount').textContent = uniqueDrivers.length;

            statsPanel.classList.add('active');
        }

        // Display vehicle information
        function displayVehicleInformation(vehicleData) {
            if (!vehicleData) return;

            vehicleInfo.innerHTML = `
                <div class="info-item">
                    <strong>BA Number</strong>
                    <span>${vehicleData.BA_number || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <strong>Make</strong>
                    <span>${vehicleData.make || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <strong>Model</strong>
                    <span>${vehicleData.model || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <strong>Type</strong>
                    <span>${vehicleData.type || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <strong>Unit</strong>
                    <span>${vehicleData.unit || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <strong>Total Mileage</strong>
                    <span>${vehicleData.total_milage || 0} km</span>
                </div>
            `;

            vehicleInfoPanel.classList.add('active');
        }

        // Display driver information
        function displayDriverInformation(driverData) {
            if (!driverData || driverData.length === 0) {
                driverInfo.innerHTML = '<div class="info-item"><span>No driver information available</span></div>';
                driverInfoPanel.classList.add('active');
                return;
            }

            const driverItems = driverData.map(driver => `
                <div class="info-item">
                    <strong>${driver.name || 'Unknown Driver'}</strong>
                    <span>Rank: ${driver.rank || 'N/A'}<br>
                    Army No: ${driver.army_number || 'N/A'}<br>
                    Unit: ${driver.unit || 'N/A'}</span>
                </div>
            `).join('');

            driverInfo.innerHTML = driverItems;
            driverInfoPanel.classList.add('active');
        }

        // Calculate distance between two GPS points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            return distance;
        }

        // Clear map
        function clearMap() {
            // Clear route path
            if (currentPath) {
                map.removeLayer(currentPath);
                currentPath = null;
            }

            // Clear all markers
            currentMarkers.forEach(marker => map.removeLayer(marker));
            currentMarkers = [];

            // Clear event markers
            Object.keys(eventMarkers).forEach(eventType => {
                eventMarkers[eventType].forEach(marker => map.removeLayer(marker));
                eventMarkers[eventType] = [];
                updateButtonState(eventType, false);
            });

            // Clear active events
            activeEvents.clear();

            // Hide info panels
            vehicleInfoPanel.classList.remove('active');
            driverInfoPanel.classList.remove('active');
            statsPanel.classList.remove('active');

            // Reset route data
            currentRouteData = null;

            // Disable event buttons
            harshBrakeBtn.disabled = true;
            harshAccelBtn.disabled = true;
            overspeedBtn.disabled = true;
            routeLoaded = false;
        }

        // Show loading indicator
        function showLoading(show, message = 'Loading...') {
            if (show) {
                loadingText.textContent = message;
                loadingIndicator.classList.add('active');
                loadRouteBtn.disabled = true;
            } else {
                loadingIndicator.classList.remove('active');
                loadRouteBtn.disabled = false;
            }
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('active');
        }

        // Hide error message
        function hideError() {
            errorMessage.classList.remove('active');
        }

        // Logout function
        function logout() {
            document.getElementById('logoutModal').style.display = 'block';
        }

        // Close logout modal
        function closeLogoutModal() {
            document.getElementById('logoutModal').style.display = 'none';
        }

        // Confirm logout
        function confirmLogout() {
            window.location.href = '/logout';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('logoutModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>