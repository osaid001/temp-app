<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Vehicle Tracking</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 50%, #1a472a 100%);
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.03)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.03)"/><circle cx="50" cy="10" r="1" fill="rgba(255,255,255,0.02)"/><circle cx="90" cy="40" r="1" fill="rgba(255,255,255,0.02)"/></pattern></defs><rect width="100%" height="100%" fill="url(%23grain)"/></svg>');
            opacity: 0.4;
            z-index: 1;
        }

        .navbar {
            background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 50%, #1a472a 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 10;
            border-bottom: 3px solid #d4af37;
        }

        .navbar h1 {
            font-size: 28px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            color: #fff;
        }

        .navbar-links {
            display: flex;
            gap: 25px;
            align-items: center;
        }

        .navbar-links a {
            color: #fff;
            text-decoration: none;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid transparent;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .navbar-links a:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: #d4af37;
            transform: translateY(-2px);
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
            position: relative;
            z-index: 5;
        }

        .page-header {
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #d4af37;
        }

        .page-header h2 {
            color: #fff;
            font-size: 32px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            text-align: center;
        }

        .controls-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border: 2px solid #d4af37;
            padding: 25px;
            margin-bottom: 25px;
        }

        .controls-section h3 {
            color: #1a472a;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .controls-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-group {
            flex: 1;
            min-width: 180px;
            max-width: 200px;
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1a472a;
            font-size: 13px;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #d4af37;
            border-radius: 8px;
            font-size: 13px;
            transition: border-color 0.3s ease;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #b8941f;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
        }

        .button-group {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            flex-wrap: wrap;
            min-width: 320px;
        }

        .btn {
            display: inline-block;
            background: linear-gradient(145deg, #d4af37, #b8941f);
            color: #1a472a;
            padding: 10px 18px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 13px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            min-width: 75px;
            text-align: center;
        }

        .btn:hover {
            background: linear-gradient(145deg, #b8941f, #d4af37);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(145deg, #28a745, #218838);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(145deg, #218838, #28a745);
        }

        .btn-danger {
            background: linear-gradient(145deg, #dc3545, #c82333);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(145deg, #c82333, #dc3545);
        }

        .btn-secondary {
            background: linear-gradient(145deg, #6c757d, #545b62);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(145deg, #545b62, #6c757d);
        }

        .btn-warning {
            background: linear-gradient(145deg, #ffc107, #e0a800);
            color: #1a472a;
        }

        .btn-warning:hover {
            background: linear-gradient(145deg, #e0a800, #ffc107);
        }

        .info-panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border: 2px solid #d4af37;
            padding: 20px;
            display: none;
        }

        .info-panel.active {
            display: block;
        }

        .info-panel h4 {
            color: #1a472a;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            border-bottom: 1px solid #d4af37;
            padding-bottom: 8px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #d4af37;
        }

        .info-item strong {
            color: #1a472a;
            display: block;
            font-size: 0.9em;
            margin-bottom: 4px;
        }

        .info-item span {
            color: #495057;
            font-size: 1em;
        }

        .status-indicator {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 16px;
        }

        .status-live {
            background: rgba(40, 167, 69, 0.1);
            border: 2px solid #28a745;
            color: #28a745;
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .status-stopped {
            background: rgba(255, 193, 7, 0.1);
            border: 2px solid #ffc107;
            color: #856404;
        }

        .status-offline {
            background: rgba(220, 53, 69, 0.1);
            border: 2px solid #dc3545;
            color: #dc3545;
        }

        .status-initializing {
            background: rgba(0, 123, 255, 0.1);
            border: 2px solid #007bff;
            color: #007bff;
        }

        .map-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border: 2px solid #d4af37;
            overflow: hidden;
            height: 600px;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 25px 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
            display: none;
            border: 2px solid #d4af37;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #d4af37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 2px solid #dc3545;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: center;
            display: none;
            font-weight: 500;
        }

        .error-message.active {
            display: block;
        }

        .legend {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 13px;
            border: 2px solid #d4af37;
            min-width: 180px;
        }

        .legend h5 {
            color: #1a472a;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: bold;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .legend-line {
            width: 20px;
            height: 3px;
            margin-right: 8px;
            border-radius: 2px;
        }

        .logout-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .logout-modal-content {
            background-color: #fff;
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border: 2px solid #d4af37;
            text-align: center;
        }

        .logout-modal h3 {
            color: #1a472a;
            font-size: 20px;
            margin-bottom: 20px;
        }

        .logout-modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .logout-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn-cancel {
            background: #6c757d;
            color: white;
        }

        .logout-btn-cancel:hover {
            background: #545b62;
        }

        .logout-btn-confirm {
            background: linear-gradient(145deg, #d4af37, #b8941f);
            color: #1a472a;
        }

        .logout-btn-confirm:hover {
            background: linear-gradient(145deg, #b8941f, #d4af37);
        }

        /* Vehicle markers styles */
        .vehicle-marker {
            background: #28a745;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 5px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        /* Responsive design */
        @media (max-width: 1024px) {
            .controls-row {
                justify-content: flex-start;
            }

            .control-group {
                min-width: 160px;
                max-width: 180px;
            }

            .button-group {
                min-width: 280px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }

            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                min-width: 100%;
                max-width: 100%;
            }

            .button-group {
                min-width: 100%;
                justify-content: center;
            }

            .info-panels {
                grid-template-columns: 1fr;
            }

            .navbar {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }

            .navbar h1 {
                font-size: 24px;
            }

            .page-header h2 {
                font-size: 24px;
            }

            .map-container {
                height: 500px;
            }

            .legend {
                position: relative;
                bottom: auto;
                right: auto;
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <h1>Live Vehicle Tracking</h1>
        <div class="navbar-links">
            <a href="/dashboard">Dashboard</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <div class="page-header">
            <h2>Live Vehicle Tracking Dashboard</h2>
        </div>

        <!-- Vehicle Selection and Controls -->
        <div class="controls-section">
            <h3>Vehicle Selection & Tracking Controls</h3>
            <div class="controls-row">
                <div class="control-group">
                    <label for="vehicleSelect">Vehicle (BA Number)</label>
                    <select id="vehicleSelect">
                        <option value="">-- Select Vehicle --</option>
                        <option value="all">üåç Track All Live</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="baNumberInput">Or Enter BA Number</label>
                    <input type="text" id="baNumberInput" placeholder="Enter BA Number" />
                </div>
                <div class="button-group">
                    <button class="btn btn-success" id="trackBtn" onclick="startTracking()">Track</button>
                    <button class="btn btn-danger" id="stopBtn" onclick="stopTracking()" disabled>Stop</button>
                    <button class="btn btn-secondary" onclick="clearMap()">Clear</button>
                    <button class="btn btn-warning" id="refreshBtn" onclick="refreshData()" disabled>Refresh</button>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error-message"></div>

        <!-- Information Panels -->
        <div class="info-panels">
            <!-- Vehicle Information Panel -->
            <div id="vehicleInfoPanel" class="info-panel">
                <h4 id="vehicleInfoTitle">üöõ Vehicle Information</h4>
                <div id="vehicleInfo" class="info-grid">
                    <!-- Vehicle details will be populated here -->
                </div>
            </div>

            <!-- Driver Information Panel -->
            <div id="driverInfoPanel" class="info-panel">
                <h4>üë§ Tracking Status</h4>
                <div id="trackingStatus" class="status-indicator">
                    Waiting for tracking...
                </div>
                <div id="driverInfo" class="info-grid">
                    <!-- Driver details will be populated here -->
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>
            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                <div id="loadingText">Initializing tracking...</div>
            </div>
            <div class="legend">
                <h5>Map Legend</h5>
                <div class="legend-item">
                    <div class="legend-line" style="background: #3498db;"></div>
                    <span>Vehicle Path</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #28a745;"></div>
                    <span>Live Position</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #dc3545;"></div>
                    <span>Overspeeding</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e67e22;"></div>
                    <span>Harsh Braking</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #9b59b6;"></div>
                    <span>Harsh Acceleration</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffc107;"></div>
                    <span>Start Position</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Logout Modal -->
    <div id="logoutModal" class="logout-modal">
        <div class="logout-modal-content">
            <h3>Logout Confirmation</h3>
            <p>Are you sure you want to logout?</p>
            <div class="logout-modal-buttons">
                <button class="logout-btn logout-btn-cancel" onclick="closeLogoutModal()">Cancel</button>
                <button class="logout-btn logout-btn-confirm" onclick="confirmLogout()">OK</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Global variables
        let map;
        let trackingInterval;
        let isTracking = false;
        let trackingStartTime;
        let currentVehicleId = null;
        let trackingMode = 'single'; // 'single' or 'all'

        // Data structures for tracking
        let vehicleData = new Map(); // Map of vehicleId -> { path: [], markers: {}, lastUpdate: Date }
        let lastDataCheck = new Date();
        let connectionLost = false;

        // Status tracking for delayed decisions
        let vehicleStatusHistory = new Map(); // vehicleId -> { consecutiveOfflineChecks: 0, lastStatusChange: Date }
        let systemStatusHistory = {
            consecutiveNoDataChecks: 0,
            lastStatusChange: new Date()
        };

        // DOM elements
        const vehicleSelect = document.getElementById('vehicleSelect');
        const baNumberInput = document.getElementById('baNumberInput');
        const trackBtn = document.getElementById('trackBtn');
        const stopBtn = document.getElementById('stopBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const errorMessage = document.getElementById('errorMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const loadingText = document.getElementById('loadingText');
        const vehicleInfoPanel = document.getElementById('vehicleInfoPanel');
        const driverInfoPanel = document.getElementById('driverInfoPanel');
        const vehicleInfo = document.getElementById('vehicleInfo');
        const vehicleInfoTitle = document.getElementById('vehicleInfoTitle');
        const driverInfo = document.getElementById('driverInfo');
        const trackingStatus = document.getElementById('trackingStatus');

        // Colors for different vehicles in all-vehicles mode
        const vehicleColors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#34495e', '#e67e22'];

        // Constants for timing
        const STATUS_CHANGE_DELAY_CHECKS = 6; // Wait 6 checks (30 seconds) before changing status
        const OFFLINE_THRESHOLD_SECONDS = 30; // Consider vehicle offline after 30 seconds

        // Initialize map
        function initMap() {
            map = L.map('map').setView([33.6844, 73.0479], 12); // Default to Islamabad

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadVehicles();

            // Add event listeners
            vehicleSelect.addEventListener('change', onVehicleSelect);
            baNumberInput.addEventListener('input', onBANumberInput);
        });

        // Load all vehicles for dropdown
        async function loadVehicles() {
            try {
                showLoading(true, 'Loading vehicles...');
                const response = await fetch('/api/vehicles');
                const data = await response.json();

                if (data.success) {
                    vehicleSelect.innerHTML = '<option value="">-- Select Vehicle --</option><option value="all">üåç Track All Live Vehicles</option>';
                    data.vehicles.forEach(vehicle => {
                        const option = document.createElement('option');
                        option.value = vehicle.id;
                        option.textContent = vehicle.BA_number;
                        vehicleSelect.appendChild(option);
                    });
                } else {
                    showError('Failed to load vehicles: ' + data.message);
                }
            } catch (error) {
                showError('Failed to load vehicles: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Handle vehicle selection from dropdown
        function onVehicleSelect() {
            const selectedValue = vehicleSelect.value;
            if (selectedValue) {
                baNumberInput.value = '';
                currentVehicleId = selectedValue;
                trackingMode = selectedValue === 'all' ? 'all' : 'single';
            } else {
                currentVehicleId = null;
                trackingMode = 'single';
            }
            hideError();
        }

        // Handle BA number input
        function onBANumberInput() {
            const inputValue = baNumberInput.value.trim();
            if (inputValue) {
                vehicleSelect.value = '';
                currentVehicleId = inputValue;
                trackingMode = 'single';
            } else {
                currentVehicleId = null;
                trackingMode = 'single';
            }
            hideError();
        }

        // Start tracking
        async function startTracking() {
            if (!currentVehicleId) {
                showError('Please select a vehicle or enter a BA number');
                return;
            }

            try {
                // Show immediate feedback
                updateTrackingStatus('initializing', 'Initializing tracking...');
                showLoading(true, 'Starting tracking...');

                // Set tracking start time
                trackingStartTime = new Date();
                lastDataCheck = new Date(trackingStartTime.getTime() - 5000); // Start checking 5 seconds ago

                // Reset tracking state
                vehicleData.clear();
                vehicleStatusHistory.clear();
                systemStatusHistory = {
                    consecutiveNoDataChecks: 0,
                    lastStatusChange: new Date()
                };
                clearMapElements();
                connectionLost = false;

                // Start tracking
                isTracking = true;

                // Update UI immediately
                trackBtn.disabled = true;
                stopBtn.disabled = false;
                refreshBtn.disabled = false;

                // Show info panels
                vehicleInfoPanel.classList.add('active');
                driverInfoPanel.classList.add('active');

                if (trackingMode === 'all') {
                    // Track all vehicles
                    vehicleInfoTitle.textContent = 'üåç All Live Vehicles';
                    updateTrackingStatus('initializing', 'Initializing All Vehicles Tracking...');

                    // Load all live vehicles immediately
                    await loadAllLiveVehicles();

                } else {
                    // Track single vehicle
                    // Resolve BA number if needed
                    let vehicleId = currentVehicleId;
                    if (baNumberInput.value.trim()) {
                        const resolvedId = await resolveBANumber(baNumberInput.value.trim());
                        if (!resolvedId) {
                            showError('Vehicle with BA number "' + baNumberInput.value.trim() + '" not found');
                            stopTracking();
                            return;
                        }
                        vehicleId = resolvedId;
                    }

                    currentVehicleId = vehicleId;
                    vehicleInfoTitle.textContent = 'üöõ Vehicle Information';
                    updateTrackingStatus('initializing', 'Initializing Vehicle Tracking...');

                    // Load vehicle details
                    await loadVehicleDetails(vehicleId);

                    // Initialize vehicle data structure
                    initializeVehicleData(vehicleId);
                    initializeVehicleStatusHistory(vehicleId);
                }

                // Start the tracking interval (check every 5 seconds for responsiveness)
                trackingInterval = setInterval(checkForNewData, 5000);

                // Check immediately
                await checkForNewData();

                hideError();
                showLoading(false);

            } catch (error) {
                showError('Failed to start tracking: ' + error.message);
                stopTracking();
                showLoading(false);
            }
        }

        // Stop tracking
        function stopTracking() {
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }

            isTracking = false;
            trackBtn.disabled = false;
            stopBtn.disabled = true;
            refreshBtn.disabled = true;

            updateTrackingStatus('offline', 'Tracking Stopped');
        }

        // Initialize vehicle data structure
        function initializeVehicleData(vehicleId) {
            if (!vehicleData.has(vehicleId)) {
                vehicleData.set(vehicleId, {
                    path: [],
                    markers: {
                        current: null,
                        start: null,
                        events: []
                    },
                    lastUpdate: null,
                    lastPosition: null,
                    polyline: null,
                    info: null,
                    color: vehicleColors[vehicleData.size % vehicleColors.length]
                });
            }
        }

        // Initialize vehicle status history for delayed decisions
        function initializeVehicleStatusHistory(vehicleId) {
            if (!vehicleStatusHistory.has(vehicleId)) {
                vehicleStatusHistory.set(vehicleId, {
                    consecutiveOfflineChecks: 0,
                    lastStatusChange: new Date(),
                    currentStatus: 'initializing'
                });
            }
        }

        // Load all live vehicles
        async function loadAllLiveVehicles() {
            try {
                const response = await fetch('/api/live-vehicles');
                const data = await response.json();

                if (data.success && data.vehicles.length > 0) {
                    // Initialize data structures for all live vehicles
                    data.vehicles.forEach(vehicle => {
                        initializeVehicleData(vehicle.vehicle_id);
                        initializeVehicleStatusHistory(vehicle.vehicle_id);
                    });

                    // Update vehicle info display
                    displayAllVehiclesInfo(data.vehicles);

                    // Set initial status
                    updateTrackingStatus('live', `Tracking ${data.vehicles.length} vehicles - Started at ${trackingStartTime.toLocaleTimeString()}`);
                } else {
                    // No live vehicles found - but don't immediately show "no live vehicles"
                    // Wait for delayed decision
                    vehicleInfo.innerHTML = '<div class="info-item"><strong>Status</strong><span>Searching for live vehicles...</span></div>';
                    updateTrackingStatus('initializing', 'Searching for live vehicles...');
                }
            } catch (error) {
                console.error('Error loading live vehicles:', error);
                showError('Failed to load live vehicles');
            }
        }

        // Display all vehicles info
        function displayAllVehiclesInfo(vehicles) {
            vehicleInfo.innerHTML = vehicles.map(vehicle => `
                <div class="info-item">
                    <strong>${vehicle.BA_number || vehicle.vehicle_id}</strong>
                    <span>Live (${vehicle.last_update ? new Date(vehicle.last_update).toLocaleTimeString() : 'Unknown'})</span>
                </div>
            `).join('');
        }

        // Resolve BA number to vehicle ID
        async function resolveBANumber(baNumber) {
            try {
                const response = await fetch(`/api/vehicle-by-ba/${encodeURIComponent(baNumber)}`);
                const data = await response.json();

                if (data.success) {
                    return data.vehicle.id;
                }
                return null;
            } catch (error) {
                console.error('Error resolving BA number:', error);
                return null;
            }
        }

        // Load vehicle details
        async function loadVehicleDetails(vehicleId) {
            try {
                const response = await fetch(`/api/vehicle-details/${vehicleId}`);
                const data = await response.json();

                if (data.success) {
                    displayVehicleInfo(data.vehicle);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('Error loading vehicle details:', error);
                showError('Failed to load vehicle details');
            }
        }

        // Display vehicle information
        function displayVehicleInfo(vehicle) {
            vehicleInfo.innerHTML = `
                <div class="info-item">
                    <strong>BA Number</strong>
                    <span>${vehicle.BA_number || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <strong>Make</strong>
                    <span>${vehicle.make || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <strong>Type</strong>
                    <span>${vehicle.type || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <strong>Model</strong>
                    <span>${vehicle.model || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <strong>Unit</strong>
                    <span>${vehicle.unit || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <strong>Total Mileage</strong>
                    <span>${vehicle.total_milage ? vehicle.total_milage + ' km' : 'N/A'}</span>
                </div>
            `;
        }

        // Display driver information
        function displayDriverInfo(driver) {
            driverInfo.innerHTML = `
                <div class="info-item">
                    <strong>Name</strong>
                    <span>${driver.name || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <strong>Rank</strong>
                    <span>${driver.rank || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <strong>Army Number</strong>
                    <span>${driver.army_number || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <strong>Unit</strong>
                    <span>${driver.unit || 'N/A'}</span>
                </div>
            `;
        }

        // Check for new data
        async function checkForNewData() {
            if (!isTracking) return;

            try {
                if (trackingMode === 'all') {
                    await checkAllVehiclesData();
                } else {
                    await checkSingleVehicleData();
                }

                // Update connection status
                connectionLost = false;

            } catch (error) {
                console.error('Error checking GPS data:', error);
                if (!connectionLost) {
                    updateTrackingStatus('offline', 'Connection error - Retrying...');
                    connectionLost = true;
                }
            }
        }

        // Check single vehicle data with delayed offline detection
        async function checkSingleVehicleData() {
            const response = await fetch(`/api/live-gps-data/${currentVehicleId}?since=${lastDataCheck.toISOString()}`);
            const data = await response.json();

            const vehicleStatus = vehicleStatusHistory.get(currentVehicleId);

            if (data.success && data.data && data.data.length > 0) {
                // Process new GPS points
                const newPoints = data.data.filter(point => {
                    const pointTime = new Date(point.timestamp);
                    return pointTime > lastDataCheck;
                }).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                if (newPoints.length > 0) {
                    processNewGPSPoints(currentVehicleId, newPoints);
                    lastDataCheck = new Date(newPoints[newPoints.length - 1].timestamp);

                    // Reset offline counter - vehicle is active
                    vehicleStatus.consecutiveOfflineChecks = 0;

                    // Update to live status immediately if it was offline
                    if (vehicleStatus.currentStatus !== 'live') {
                        vehicleStatus.currentStatus = 'live';
                        vehicleStatus.lastStatusChange = new Date();
                        updateTrackingStatus('live', `Live Tracking - Last Update: ${new Date().toLocaleTimeString()}`);
                    } else {
                        updateTrackingStatus('live', `Live Tracking - Last Update: ${new Date().toLocaleTimeString()}`);
                    }

                    // Display driver info from the latest point
                    if (newPoints.length > 0) {
                        const latestPoint = newPoints[newPoints.length - 1];
                        if (latestPoint.driver_name) {
                            displayDriverInfo({
                                name: latestPoint.driver_name,
                                rank: latestPoint.driver_rank,
                                army_number: latestPoint.driver_army_number,
                                unit: latestPoint.driver_unit
                            });
                        }
                    }
                }
            } else {
                // No new data - increment offline counter
                vehicleStatus.consecutiveOfflineChecks++;

                // Only change to offline after consistent offline checks
                if (vehicleStatus.consecutiveOfflineChecks >= STATUS_CHANGE_DELAY_CHECKS && vehicleStatus.currentStatus === 'live') {
                    vehicleStatus.currentStatus = 'offline';
                    vehicleStatus.lastStatusChange = new Date();
                    updateTrackingStatus('offline', 'Vehicle Not Live - No GPS data for >30 seconds');
                }

                // Check if vehicle has any data at all
                const vehicle = vehicleData.get(currentVehicleId);
                if (!vehicle || !vehicle.lastUpdate) {
                    // Vehicle never had data, check if we should show "not live" message
                    if (vehicleStatus.consecutiveOfflineChecks >= STATUS_CHANGE_DELAY_CHECKS) {
                        updateTrackingStatus('offline', 'Vehicle Not Live - No GPS data available');
                    }
                }
            }
        }

        // Check all vehicles data with delayed offline detection
        async function checkAllVehiclesData() {
            const response = await fetch(`/api/all-live-gps-data?since=${lastDataCheck.toISOString()}`);
            const data = await response.json();

            if (data.success && data.vehicles) {
                let totalNewPoints = 0;
                let activeVehicles = 0;

                for (const vehicleId in data.vehicles) {
                    const vehiclePoints = data.vehicles[vehicleId];

                    if (vehiclePoints.length > 0) {
                        // Initialize vehicle data if not exists
                        if (!vehicleData.has(vehicleId)) {
                            initializeVehicleData(vehicleId);
                            initializeVehicleStatusHistory(vehicleId);
                        }

                        const vehicleStatus = vehicleStatusHistory.get(vehicleId);

                        const newPoints = vehiclePoints.filter(point => {
                            const pointTime = new Date(point.timestamp);
                            return pointTime > lastDataCheck;
                        }).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                        if (newPoints.length > 0) {
                            processNewGPSPoints(vehicleId, newPoints);
                            totalNewPoints += newPoints.length;
                            activeVehicles++;

                            // Reset offline counter for this vehicle
                            vehicleStatus.consecutiveOfflineChecks = 0;
                            vehicleStatus.currentStatus = 'live';
                        } else {
                            // Increment offline counter for this vehicle
                            vehicleStatus.consecutiveOfflineChecks++;
                        }
                    }
                }

                // Update last check time
                lastDataCheck = new Date();

                if (totalNewPoints > 0) {
                    // Reset system offline counter
                    systemStatusHistory.consecutiveNoDataChecks = 0;

                    // Count live vehicles (with recent activity)
                    let liveCount = 0;
                    let stoppedCount = 0;

                    vehicleStatusHistory.forEach((status, vehicleId) => {
                        if (status.consecutiveOfflineChecks < STATUS_CHANGE_DELAY_CHECKS) {
                            liveCount++;
                        } else {
                            stoppedCount++;
                        }
                    });

                    updateTrackingStatus('live', `Tracking: ${liveCount} live, ${stoppedCount} stopped - Last Update: ${new Date().toLocaleTimeString()}`);
                } else {
                    // No new data - increment system offline counter
                    systemStatusHistory.consecutiveNoDataChecks++;

                    // Only change status after delay
                    if (systemStatusHistory.consecutiveNoDataChecks >= STATUS_CHANGE_DELAY_CHECKS) {
                        const totalVehicles = vehicleStatusHistory.size;
                        if (totalVehicles === 0) {
                            updateTrackingStatus('offline', 'No live vehicles found');
                            vehicleInfo.innerHTML = '<div class="info-item"><strong>Status</strong><span>No live vehicles found</span></div>';
                        } else {
                            updateTrackingStatus('offline', `All ${totalVehicles} vehicles stopped transmitting`);
                        }
                    }
                }
            } else {
                // Handle API error
                systemStatusHistory.consecutiveNoDataChecks++;
                if (systemStatusHistory.consecutiveNoDataChecks >= STATUS_CHANGE_DELAY_CHECKS) {
                    updateTrackingStatus('offline', 'No live vehicles data available');
                }
            }
        }

        // Process new GPS points
        function processNewGPSPoints(vehicleId, newPoints) {
            const vehicle = vehicleData.get(vehicleId);
            if (!vehicle) return;

            newPoints.forEach((point, index) => {
                // Validate point data
                if (!point.lat || !point.lon || !point.timestamp) {
                    console.warn('Invalid GPS point:', point);
                    return;
                }

                const lat = parseFloat(point.lat);
                const lon = parseFloat(point.lon);

                if (isNaN(lat) || isNaN(lon)) {
                    console.warn('Invalid coordinates:', point);
                    return;
                }

                // Add to vehicle path (maintain chronological order)
                vehicle.path.push({
                    lat: lat,
                    lon: lon,
                    timestamp: point.timestamp,
                    speed: point.speed || 0,
                    driver: {
                        name: point.driver_name,
                        rank: point.driver_rank,
                        army_number: point.driver_army_number,
                        unit: point.driver_unit
                    }
                });

                vehicle.lastUpdate = new Date(point.timestamp);
                vehicle.lastPosition = { lat, lon };

                // Check for events and add markers
                checkAndAddEventMarkers(vehicleId, point, index > 0 ? newPoints[index - 1] : getLastValidPoint(vehicle.path, newPoints, index));
            });

            // Update map display for this vehicle
            updateVehicleDisplay(vehicleId);
        }

        // Get last valid point for comparison
        function getLastValidPoint(path, newPoints, currentIndex) {
            if (currentIndex > 0) {
                return newPoints[currentIndex - 1];
            }
            return path.length > 1 ? path[path.length - 2] : null;
        }

        // Check and add event markers
        function checkAndAddEventMarkers(vehicleId, currentPoint, previousPoint) {
            const lat = parseFloat(currentPoint.lat);
            const lon = parseFloat(currentPoint.lon);
            const speed = parseFloat(currentPoint.speed) || 0;
            const timestamp = new Date(currentPoint.timestamp);

            // Check for overspeeding (assuming speed limit of 60 km/h)
            if (speed > 60) {
                addEventMarker(vehicleId, lat, lon, 'overspeeding', {
                    title: 'Overspeeding Event',
                    details: `Speed: ${speed.toFixed(1)} km/h\nTime: ${timestamp.toLocaleString()}\nDriver: ${currentPoint.driver_name || 'Unknown'}`,
                    speed: speed,
                    overLimit: speed - 60
                });
            }

            // Check for harsh braking and acceleration if we have previous point
            if (previousPoint) {
                const prevSpeed = parseFloat(previousPoint.speed) || 0;
                const speedChange = speed - prevSpeed;
                const timeChange = (new Date(currentPoint.timestamp) - new Date(previousPoint.timestamp)) / 1000; // seconds

                if (timeChange > 0 && timeChange < 300) { // Only consider if time difference is reasonable (< 5 minutes)
                    // Calculate acceleration/deceleration per second
                    const acceleration = speedChange / timeChange;

                    // Harsh braking (significant speed decrease)
                    if (acceleration < -3) { // Losing more than 3 km/h per second
                        addEventMarker(vehicleId, lat, lon, 'harsh_braking', {
                            title: 'Harsh Braking Event',
                            details: `Previous Speed: ${prevSpeed.toFixed(1)} km/h\nCurrent Speed: ${speed.toFixed(1)} km/h\nTime: ${timestamp.toLocaleString()}\nDriver: ${currentPoint.driver_name || 'Unknown'}`,
                            speedChange: speedChange,
                            acceleration: acceleration
                        });
                    }

                    // Harsh acceleration (significant speed increase)
                    if (acceleration > 3) { // Gaining more than 3 km/h per second
                        addEventMarker(vehicleId, lat, lon, 'harsh_acceleration', {
                            title: 'Harsh Acceleration Event',
                            details: `Previous Speed: ${prevSpeed.toFixed(1)} km/h\nCurrent Speed: ${speed.toFixed(1)} km/h\nTime: ${timestamp.toLocaleString()}\nDriver: ${currentPoint.driver_name || 'Unknown'}`,
                            speedChange: speedChange,
                            acceleration: acceleration
                        });
                    }
                }
            }
        }

        // Add event marker to map
        function addEventMarker(vehicleId, lat, lon, eventType, eventData) {
            const vehicle = vehicleData.get(vehicleId);
            if (!vehicle) return;

            let color, icon;

            switch (eventType) {
                case 'overspeeding':
                    color = '#dc3545';
                    icon = '‚ö°';
                    break;
                case 'harsh_braking':
                    color = '#e67e22';
                    icon = 'üõë';
                    break;
                case 'harsh_acceleration':
                    color = '#9b59b6';
                    icon = 'üöÄ';
                    break;
                default:
                    color = '#ffc107';
                    icon = '‚ö†Ô∏è';
            }

            const marker = L.marker([lat, lon], {
                icon: L.divIcon({
                    className: 'event-marker',
                    html: `<div style="background: ${color}; color: white; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 10px;">${icon}</div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(map);

            const vehicleInfo = trackingMode === 'single' ? '' : `<p style="margin: 0;"><strong>Vehicle:</strong> ${vehicleId}</p>`;

            marker.bindPopup(`
                <div style="min-width: 200px;">
                    <h4 style="margin: 0 0 10px 0; color: ${color};">${eventData.title}</h4>
                    ${vehicleInfo}
                    <p style="margin: 0; white-space: pre-line; font-size: 12px;">${eventData.details}</p>
                </div>
            `);

            vehicle.markers.events.push(marker);
        }

        // Update vehicle display on map
        function updateVehicleDisplay(vehicleId) {
            const vehicle = vehicleData.get(vehicleId);
            if (!vehicle || vehicle.path.length === 0) return;

            const pathCoords = vehicle.path.map(point => [point.lat, point.lon]);

            // Update or create path polyline
            if (vehicle.polyline) {
                vehicle.polyline.setLatLngs(pathCoords);
            } else {
                vehicle.polyline = L.polyline(pathCoords, {
                    color: vehicle.color,
                    weight: 3,
                    opacity: 0.7
                }).addTo(map);
            }

            // Update current position marker
            const currentPos = vehicle.lastPosition;
            const currentPoint = vehicle.path[vehicle.path.length - 1];

            if (vehicle.markers.current) {
                vehicle.markers.current.setLatLng([currentPos.lat, currentPos.lon]);
            } else {
                vehicle.markers.current = L.marker([currentPos.lat, currentPos.lon], {
                    icon: L.divIcon({
                        className: 'current-marker',
                        html: `<div style="background: ${vehicle.color}; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); animation: pulse 2s infinite;"></div>`,
                        iconSize: [14, 14],
                        iconAnchor: [7, 7]
                    })
                }).addTo(map);

                const vehicleInfo = trackingMode === 'single' ? '' : `<p style="margin: 0;"><strong>Vehicle:</strong> ${vehicleId}</p>`;

                vehicle.markers.current.bindPopup(`
                    <div style="min-width: 200px;">
                        <h4 style="margin: 0 0 10px 0; color: ${vehicle.color};">Current Position</h4>
                        ${vehicleInfo}
                        <p style="margin: 0;"><strong>Speed:</strong> ${(currentPoint.speed || 0).toFixed(1)} km/h</p>
                        <p style="margin: 0;"><strong>Time:</strong> ${new Date(currentPoint.timestamp).toLocaleString()}</p>
                        <p style="margin: 0;"><strong>Driver:</strong> ${currentPoint.driver.name || 'Unknown'}</p>
                    </div>
                `);
            }

            // Add start marker if this is the first point
            if (vehicle.path.length === 1 && !vehicle.markers.start) {
                vehicle.markers.start = L.marker([currentPos.lat, currentPos.lon], {
                    icon: L.divIcon({
                        className: 'start-marker',
                        html: '<div style="background: #ffc107; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                        iconSize: [12, 12],
                        iconAnchor: [6, 6]
                    })
                }).addTo(map);

                const vehicleInfo = trackingMode === 'single' ? '' : `<p style="margin: 0;"><strong>Vehicle:</strong> ${vehicleId}</p>`;

                vehicle.markers.start.bindPopup(`
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #ffc107;">Tracking Started</h4>
                        ${vehicleInfo}
                        <p style="margin: 0;"><strong>Time:</strong> ${trackingStartTime.toLocaleString()}</p>
                    </div>
                `);
            }

            // Auto-fit map for single vehicle mode
            if (trackingMode === 'single' && vehicle.path.length > 1) {
                map.fitBounds(pathCoords, { padding: [20, 20] });
            } else if (trackingMode === 'single' && vehicle.path.length === 1) {
                map.setView([currentPos.lat, currentPos.lon], 15);
            }
        }

        // Clear all map elements
        function clearMapElements() {
            vehicleData.forEach((vehicle, vehicleId) => {
                if (vehicle.polyline) {
                    map.removeLayer(vehicle.polyline);
                }
                if (vehicle.markers.current) {
                    map.removeLayer(vehicle.markers.current);
                }
                if (vehicle.markers.start) {
                    map.removeLayer(vehicle.markers.start);
                }
                vehicle.markers.events.forEach(marker => map.removeLayer(marker));
            });
        }

        // Clear entire map - FIXED
        function clearMap() {
            // Stop tracking if active
            if (isTracking) {
                stopTracking();
            }

            // Clear all map elements
            clearMapElements();

            // Clear all data structures
            vehicleData.clear();
            vehicleStatusHistory.clear();
            systemStatusHistory = {
                consecutiveNoDataChecks: 0,
                lastStatusChange: new Date()
            };

            // Hide info panels
            vehicleInfoPanel.classList.remove('active');
            driverInfoPanel.classList.remove('active');

            // Clear info displays
            vehicleInfo.innerHTML = '';
            driverInfo.innerHTML = '';

            // Reset tracking status
            updateTrackingStatus('offline', 'Waiting for tracking...');

            // Reset map view
            map.setView([33.6844, 73.0479], 12);

            // Clear selections
            vehicleSelect.value = '';
            baNumberInput.value = '';
            currentVehicleId = null;
            trackingMode = 'single';

            hideError();
        }

        // Refresh data manually
        async function refreshData() {
            if (!isTracking) return;

            showLoading(true, 'Refreshing...');
            try {
                await checkForNewData();
            } finally {
                showLoading(false);
            }
        }

        // Update tracking status
        function updateTrackingStatus(status, message) {
            trackingStatus.className = `status-indicator status-${status}`;
            trackingStatus.textContent = message;
        }

        // Show loading indicator
        function showLoading(show, message = 'Loading...') {
            loadingIndicator.classList.toggle('active', show);
            if (message) {
                loadingText.textContent = message;
            }
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('active');
        }

        // Hide error message
        function hideError() {
            errorMessage.classList.remove('active');
        }

        // Logout functions
        function logout() {
            document.getElementById('logoutModal').style.display = 'block';
        }

        function closeLogoutModal() {
            document.getElementById('logoutModal').style.display = 'none';
        }

        function confirmLogout() {
            // Stop tracking if active
            if (isTracking) {
                stopTracking();
            }
            // Redirect to logout route
            window.location.href = '/logout';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const logoutModal = document.getElementById('logoutModal');
            if (event.target === logoutModal) {
                closeLogoutModal();
            }
        };

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (isTracking) {
                stopTracking();
            }
        });
    </script>
</body>
</html>